#!/bin/sh

set -e

dir=$(dirname "$0")/../..
cd "$dir"

echo "Starting development mode with hot reloading..."
echo "Project will rebuild automatically when files change"
echo "Browser will refresh automatically"

# Build initially
$ROOT_DIR/bin/sh/build

# Start browser-sync with hot reloading
# Watch for changes in output directory and index.html
## Ensure browser-sync is installed globally
if ! command -v browser-sync &> /dev/null; then
  echo "browser-sync is not installed. Installing now..."
  npm install -g browser-sync
fi
browser-sync start --server --files "output/**/*.js,index.html" --port 80 --no-open --single &
SERVER_PID=$!

echo "Development server started!"
echo "- Server: http://localhost"
echo "- Hot reloading active - browser will refresh automatically"
echo "Press Ctrl+C to stop both server and watch"

# Setup cleanup trap
trap 'echo "Stopping server..."; kill $SERVER_PID 2>/dev/null; exit' INT

# Start file watcher in foreground
spago build --watch --purs-args "-g js,sourcemaps"
