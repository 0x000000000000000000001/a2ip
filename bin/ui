#!/bin/sh

set -e

dir=$(dirname "$0")/..
cd "$dir"

echo "Starting development mode with hot reloading..."

# Build initially
$ROOT_DIR/bin/build &>/dev/null

# Start browser-sync with hot reloading
# Watch for changes in output directory and index.html
## Ensure browser-sync is installed globally
if ! command -v browser-sync &> /dev/null; then
  echo "browser-sync is not installed. Installing now..."
  npm install -g browser-sync
fi
browser-sync start --server --files "index.html,output/Ui.*/**/*.js" --reload-debounce 500 --host dev.a2ip-psychanalyse.org --port 8080 --no-open --single &
SERVER_PID=$!

echo "Development server started!"

# Setup cleanup trap
cleanup() {
  echo ""
  echo "Stopping server..."
  kill $SERVER_PID 2>/dev/null || true
  exit 0
}

trap cleanup INT TERM

# Wait indefinitely (or uncomment spago watch below)
wait $SERVER_PID
